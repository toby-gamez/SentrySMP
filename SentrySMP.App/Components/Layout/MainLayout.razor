@inherits LayoutComponentBase

<HeadContent>
    <!-- Load theme script as early as possible (before CSS) to avoid flicker on initial paint -->
    <script src="/js/theme.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css">
    <script src="/analytics-consent.js"></script>
    <script>console.log('MainLayout inline script loaded')</script>
    <!-- SEO meta tagy pro Google -->
    <meta
        name="description"
        content="SentrySMP is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."/>
    <meta
        name="keywords"
        content="Minecraft, SMP, English, Czech, server, safe, enjoyable, experience, players, vip, premium, exclusive"/>
    <meta name="author" content="Sentry SMP"/>

    <!-- Open Graph pro Facebook, Discord, aj. -->
    <meta property="og:title" content="Sentry SMP"/>
    <meta
        property="og:description"
        content="Sentry SMP server is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."/>
    <meta
        property="og:image"
        content="https://sentrysmp.eu/images/logo.png"/>
    <meta property="og:url" content="https://sentrysmp.eu/"/>
    <meta property="og:type" content="website"/>

    <!-- Twitter Cards (volitelné) -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="Sentry SMP"/>
    <meta
        name="twitter:description"
        content="Sentry SMP server is a Minecraft server focused on providing a safe and enjoyable experience for players of all ages. It is SMP with addons."/>
    <meta
        name="twitter:image"
        content="https://sentrysmp.eu/images/logo.png"/>
    <!-- Language settings -->
    <meta http-equiv="content-language" content="en"/>
    <meta name="language" content="English"/>
</HeadContent>

<div class="page">
    <div class="sidebar">
        <NavMenu/>
    </div>
    <main>
        <article class="content px-4">
            <Header />
            <div class="container">
                @Body
            </div>
            <Footer/>
        </article>
    </main>
    <CookieBanner />
</div>

@code {
}

@code {
    [Microsoft.AspNetCore.Components.Inject]
    public SentrySMP.App.Services.ThemeService ThemeService { get; set; } = default!;

    [Microsoft.AspNetCore.Components.Inject]
    public Microsoft.JSInterop.IJSRuntime JSRuntime { get; set; } = default!;

    [Microsoft.AspNetCore.Components.Inject]
    public Microsoft.AspNetCore.Components.NavigationManager NavigationManager { get; set; } = default!;

    private bool initializedTheme = false;
    private bool disposed = false;

    protected override async System.Threading.Tasks.Task OnAfterRenderAsync(bool firstRender)
    {
        if (!initializedTheme && firstRender)
        {
            initializedTheme = true;
            try
            {
                await ThemeService.InitializeAsync(JSRuntime);
            }
            catch { }

            // Subscribe to Blazor navigation events so we can re-apply theme after client navigation
            try
            {
                NavigationManager.LocationChanged += OnLocationChanged;
            }
            catch { }
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Re-apply theme after navigation — fire-and-forget
        try
        {
            await ThemeService.InitializeAsync(JSRuntime);
        }
        catch { }
    }

    public void Dispose()
    {
        if (disposed) return;
        disposed = true;
        try
        {
            NavigationManager.LocationChanged -= OnLocationChanged;
        }
        catch { }
    }
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>