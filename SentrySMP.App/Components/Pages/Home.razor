@page "/"
@inject SentrySMP.App.Services.StatusService StatusService
@inject SentrySMP.Shared.Interfaces.IAnnouncementsService AnnouncementsService
@rendermode InteractiveServer
<PageTitle>Home - SentrySMP</PageTitle>

<div class="grid-div">
	<ul class="thing-grid">
		<!--
                <a href="vip.html"
                    ><li class="thing-grid-item item-blue">VIP</li></a
                >
                 -->
		<a href="keys">
			<li class="thing-grid-item item-green">KEYS</li>
		</a>
		<a href="shards">
			<li class="thing-grid-item item-pink">SHARDS</li>
		</a>
		<a href="ranks">
			<li class="thing-grid-item item-gold">RANKS</li>
		</a>
		<a href="battlepasses"
		   ><li class="thing-grid-item item-red">BATTLE PASS</li></a>
		<a href="bundles">
			<li class="thing-grid-item item-turquoise">BUNDLES</li>
		</a>	
	</ul>
</div>
<section>
	<div style="text-align: center">
		<h2>Latest announcements</h2>
	</div>
	@if (homeLoading)
	{
	}
	else if (homeError != null)
	{
		<div class="text-danger">@homeError</div>
	}
	else if (homeAnnouncements?.Any() == true)
	{
		<div class="list-group">
			@foreach (var a in homeAnnouncements)
			{
				<div class="announcement">
					<div class="info">
						<h3 class="mb-1">@a.Title</h3>
						<div class="small text-muted">By @a.Author</div>
						<small>@a.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd")</small>
					</div>
					<div>@((MarkupString)a.HtmlContent)</div>
				</div>
			}
		</div>
	}
</section>

@code {

	// consolidated lifecycle method below handles counts and home announcements

	// home announcements
	private bool homeLoading = true;
	private string? homeError;
	private List<AnnouncementDtoWithHtml>? homeAnnouncements;

	protected override async Task OnInitializedAsync()
	{
		// nothing here; leave lifecycle in OnAfterRender for non-blocking counts
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender) return;

		// load top 3 announcements but don't block render
		_ = LoadHomeAnnouncements();

		StateHasChanged();
	}

	private async Task LoadHomeAnnouncements()
	{
		try
		{
			homeLoading = true;
			homeError = null;
			var res = (await AnnouncementsService.GetLatestAnnouncementsAsync()).Take(3).ToList();
			var pipeline = new Markdig.MarkdownPipelineBuilder().Build();
			homeAnnouncements = res.Select(r => new AnnouncementDtoWithHtml
			{
				Id = r.Id,
				Title = r.Title,
				Author = r.Author,
				Content = r.Content,
				CreatedAt = r.CreatedAt,
				HtmlContent = Markdig.Markdown.ToHtml(r.Content ?? string.Empty, pipeline)
			}).ToList();
		}
		catch
		{
			homeError = "Failed to load announcements";
		}
		finally
		{
			homeLoading = false;
			StateHasChanged();
		}
	}

	// small local helper wrapper for HTML used on home page
	private class AnnouncementDtoWithHtml : SentrySMP.Shared.DTOs.AnnouncementDto
	{
		public string HtmlContent { get; set; } = string.Empty;
	}
}