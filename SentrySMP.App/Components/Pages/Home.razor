@page "/"
@inject SentrySMP.Shared.Interfaces.IStatusService StatusService
@inject SentrySMP.Shared.Interfaces.IAnnouncementsService AnnouncementsService
@rendermode InteractiveServer
<PageTitle>Home - SentrySMP</PageTitle>

<style>
	.container {
		max-width: 1200px;
		padding: 0;
	}
	.latest-announcements {
		max-width: 1200px;
		margin: 40px auto;
		padding: 0 20px;
	}
	.announcements-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
		gap: 20px;
	}
	.latest-announcements h2 {
		text-align: center;
		margin-bottom: 30px;
		color: #333;
	}
</style>
<div class="grid-div">
	<div class="thing-grid">
		<!--
                <a href="vip.html"
                    ><li class="thing-grid-item item-blue">VIP</li></a
                >
                 -->
		<a href="keys">
			<div class="thing-grid-item">
				<div style="align-content: center;">
					<img src="images/key.png" width="90px" height="100px" style="border-radius: 0" alt="key">
				</div>
				<div style="align-content: center;">
					<p>KEYS</p>
				</div>
			</div>
		</a>
		<a href="coins">
			<div class="thing-grid-item">
				<div style="align-content: center;">
					<img src="images/coins.png" width="100px" height="100px" style="border-radius: 0" alt="coins">
				</div>
				<div style="align-content: center;">
					<p>COINS</p>
				</div>
			</div>
		</a>
		<a href="ranks">
			<div class="thing-grid-item">
				<div style="align-content: center;">
					<img src="images/rank.png" width="100px" height="100px" style="border-radius: 0" alt="rank">
				</div>
				<div style="align-content: center;">
					<p>RANKS</p>
				</div>
			</div>
		</a>
		<a href="battlepasses">
			<div class="thing-grid-item">
				<div style="align-content: center;">
					<img src="images/battlepass.png" width="100px" height="100px" style="border-radius: 0" alt="battlepass">
				</div>
				<div style="align-content: center;">
					<p>BATTLE PASSES</p>
				</div>
			</div>
		</a>
		<a href="bundles">
			<div class="thing-grid-item">
				<div style="align-content: center;">
					<img src="images/bundle.png" width="100px" height="100px" style="border-radius: 0" alt="bundle">
				</div>
				<div style="align-content: center;">
					<p>BUNDLES</p>
				</div>
			</div>
		</a>	
	</div>
</div>
<div class="latest-announcements">
	<h2>Latest announcements</h2>
	@if (homeLoading)
	{
	}
	else if (homeError != null)
	{
		<div class="text-danger">@homeError</div>
	}
	else if (homeAnnouncements?.Any() == true)
	{
		<div class="announcements-grid">
			@foreach (var a in homeAnnouncements)
			{
				<div class="announcement">
					<div class="info">
						<h3 class="mb-1">@a.Title</h3>
						<div class="small text-muted">By @a.Author</div>
						<small>@a.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd")</small>
					</div>
					<div>@((MarkupString)a.HtmlContent)</div>
				</div>
			}
		</div>
	}
	<div style="margin-left: auto; margin-right: auto; width: min-content;">
		<button onclick="window.location.href='news'" style="height: 40px; width: 100px">Show more</button>
	</div>
</div>

@code {

	// consolidated lifecycle method below handles counts and home announcements

	// home announcements
	private bool homeLoading = true;
	private string? homeError;
	private List<AnnouncementDtoWithHtml>? homeAnnouncements;

	protected override async Task OnInitializedAsync()
	{
		// nothing here; leave lifecycle in OnAfterRender for non-blocking counts
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender) return;

		// load top 3 announcements but don't block render
		_ = LoadHomeAnnouncements();

		StateHasChanged();
	}

	private async Task LoadHomeAnnouncements()
	{
		try
		{
			homeLoading = true;
			homeError = null;
			var res = (await AnnouncementsService.GetLatestAnnouncementsAsync()).Take(3).ToList();
			var pipeline = new Markdig.MarkdownPipelineBuilder().Build();
			homeAnnouncements = res.Select(r => new AnnouncementDtoWithHtml
			{
				Id = r.Id,
				Title = r.Title,
				Author = r.Author,
				Content = r.Content,
				CreatedAt = r.CreatedAt,
				HtmlContent = Markdig.Markdown.ToHtml(r.Content ?? string.Empty, pipeline)
			}).ToList();
		}
		catch
		{
			homeError = "Failed to load announcements";
		}
		finally
		{
			homeLoading = false;
			StateHasChanged();
		}
	}

	// small local helper wrapper for HTML used on home page
	private class AnnouncementDtoWithHtml : SentrySMP.Shared.DTOs.AnnouncementDto
	{
		public string HtmlContent { get; set; } = string.Empty;
	}
}