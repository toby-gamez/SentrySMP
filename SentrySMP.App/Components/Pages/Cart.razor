@page "/cart"
@using SentrySMP.Shared.DTOs
@inject SentrySMP.App.Components.State.CartState CartState
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject SentrySMP.App.Authentication.UserService UserService
@inject Microsoft.Extensions.Logging.ILoggerFactory LoggerFactory
@rendermode InteractiveServer
<PageTitle>Cart - SentrySMP</PageTitle>
<style>
    .container {
        max-width: 1200px    
    }
</style>
<div class="main-wrapper">
    <h1 class="main">Cart</h1>
</div>
<div class="cart-total">
    <strong>Total:</strong> €@CartState.CartItems.Sum(i => (i.Key.Sale > 0 ? Convert.ToDouble(i.Key.Price) * (1 - i.Key.Sale / 100.0) : Convert.ToDouble(i.Key.Price)) * i.Quantity).ToString("F2")
</div>
<div class="cart-buttons">
    <button class="danger" @onclick="ClearCart" disabled="@(CartState.CartItems.Count == 0)"><i class="bi bi-x-circle"></i> Clear Cart</button>
    <button @onclick="GoToCheckout" disabled="@(CartState.CartItems.Count == 0 || !_isLoggedIn)"><i class="bi bi-bag-check"></i> Checkout</button>
</div>
@if (!_isLoggedIn)
{
    <p style="color:red;">You are not logged in.</p>
}
    @if (CartState.CartItems.Count == 0)
    {
        <div class="alert alert-info mt-4">
            <i class="bi bi-info-circle"></i> Your cart is empty.
        </div>
    }
    else
    {
        <div class="table-wrapper">
            <table class="table table-striped mt-4">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Server</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cartItem in CartState.CartItems)
                    {
                        var item = cartItem.Key;
                        var qty = cartItem.Quantity;
                        double unitPrice = item.Sale > 0 ? Convert.ToDouble(item.Price) * (1 - item.Sale / 100.0) : Convert.ToDouble(item.Price);
                        <tr>
                            <td style="width:80px">
                                @if (!string.IsNullOrEmpty(item.Image))
                                {
                                    <img src="@item.Image" alt="@item.Name" style="height:48px;width:48px;object-fit:cover;" class="rounded" />
                                }
                                else
                                {
                                    <i class="bi bi-key-fill text-secondary" style="font-size:2rem;"></i>
                                }
                            </td>
                            <td class="table-cell-wrap">@item.Name</td>
                            <td class="table-cell-nowrap">@item.Server?.Name</td>
                            <td class="table-cell-nowrap">
                                @if (item.Sale > 0)
                                {
                                    <span class="text-muted text-decoration-line-through me-2">€@item.Price.ToString("F2")</span>
                                    <span class="text-success">€@(unitPrice.ToString("F2")) × @qty = <b>€@( (unitPrice * qty).ToString("F2") )</b></span>
                                }
                                else
                                {
                                    <span class="text-primary">€@item.Price.ToString("F2") × @qty = <b>€@( (unitPrice * qty).ToString("F2") )</b></span>
                                }
                            </td>
                            <td>
                                <div style="display:flex; align-items: center; justify-content: space-between; flex-direction: row">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" @onclick="() => ChangeQuantity(item, -1)" disabled="@(qty <= 1)">-</button>
                                    <span>@qty</span>
                                    <button class="quantity-btn" @onclick="() => ChangeQuantity(item, 1)" disabled="@(qty >= 10)">+</button>
                                </div>
                                <button class="danger" @onclick="() => RemoveFromCart(item)"><i class="bi bi-trash"></i> Remove</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
<div class="info">
    <p>
        To receive your purchase, you must be connected to the
        server where you bought items from. <b>Lobby is also a dedicated server.</b>
    </p>
</div>
@code {
    private bool _cartLoaded = false;
    private string? _username;
    private bool _isLoggedIn = false;
    private Microsoft.Extensions.Logging.ILogger? _logger;

    protected override void OnInitialized()
    {
        CartState.OnChange += StateHasChanged;
        UserService.OnChange += OnUserChanged;
        try
        {
            _logger = LoggerFactory?.CreateLogger("Cart");
        }
        catch { }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_cartLoaded)
        {
            await CartState.LoadFromStorageAsync(JS);
            _cartLoaded = true;
            await LoadUserAsync();
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        CartState.OnChange -= StateHasChanged;
        UserService.OnChange -= OnUserChanged;
    }

    private async Task RemoveFromCart(ProductResponse item)
    {
        await CartState.RemoveFromCartAsync(item);
    }
    private async Task ClearCart()
    {
        try { _logger?.LogInformation("ClearCart invoked by UI user={User} itemsCount={Count}", _username ?? string.Empty, CartState.CartItems.Count); } catch { }
        await CartState.ClearCartAsync();
        try { _logger?.LogInformation("Cart cleared by UI user={User}", _username ?? string.Empty); } catch { }
    }
    private async Task ChangeQuantity(ProductResponse item, int delta)
    {
        await CartState.ChangeQuantityAsync(item, delta);
    }

    private void GoToCheckout()
    {
        NavigationManager.NavigateTo("/checkout");
    }

    private void OnUserChanged()
    {
        _ = LoadUserAsync();
    }

    private async Task LoadUserAsync()
    {
        try
        {
            _username = await UserService.GetUsernameAsync();
            _isLoggedIn = !string.IsNullOrEmpty(_username);
        }
        catch
        {
            _username = null;
            _isLoggedIn = false;
        }
        StateHasChanged();
    }
}
