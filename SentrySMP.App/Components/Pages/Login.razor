@page "/login"
@using Microsoft.AspNetCore.Components.Forms
@inject SentrySMP.App.Authentication.UserService UserService
@inject NavigationManager Navigation

@rendermode InteractiveServer
<PageTitle>Login - SentrySMP</PageTitle>

<div class="main-wrapper">
    <h1 class="main">Login</h1>
</div>

@if (!string.IsNullOrEmpty(ExistingUsername))
{
    <h1 class="display-1">@ExistingUsername (@(IsBedrock ? "Bedrock" : "Java"))</h1>
}
<div class="mb-3">
    <div class="skin-preview-div">
        <img id="skin-preview" src="@PreviewUrl" alt="Skin preview" style="width:100px;height:100px;" />
    </div>
    
</div>
<div class="mb-3 username-field">
    <label for="username" class="field-label">Minecraft name</label>
    @if (IsBedrock)
    {
            <input id="username" class="username-input-field" @bind="UsernameEditable" @bind:event="oninput" />
    }
    else
    {
        <input id="username" class="username-input-field" @bind="UsernameEditable" @bind:event="oninput" />
    }
    <div class="field-hint">Enter username only.</div>
</div>

<div class="mb-3">
    <label class="field-label">Account type</label>
    <InputRadioGroup class="" @bind-Value="AccountType">
        <div class="edition-selector" role="tablist" aria-label="Account type">
            <label class="edition-option">
                <InputRadio class="edition-radio" Value='@("java")' />
                <span class="radio-visual" aria-hidden="true"></span>
                <span class="edition-text">Java</span>
            </label>
            <label class="edition-option">
                <InputRadio class="edition-radio" Value='@("bedrock")' />
                <span class="radio-visual" aria-hidden="true"></span>
                <span class="edition-text">Bedrock</span>
            </label>
        </div>
    </InputRadioGroup>
</div>

<div class="actions">
    <button class="btn-primary" @onclick="Save">Log in</button>
</div>

@code {
    // The value the user types in the input (no leading dot)
    private string? _usernameEditable;
    private string? UsernameEditable
    {
        get => _usernameEditable;
        set
        {
            _usernameEditable = value;
            UpdatePreview();
        }
    }

    // The full stored username as read from storage (may include leading dot for Bedrock)
    private string? ExistingUsername { get; set; }
    private bool IsBedrock => string.Equals(AccountType, "bedrock", StringComparison.OrdinalIgnoreCase);

    private string _accountType = "java";
    private string AccountType
    {
        get => _accountType;
        set
        {
            if (_accountType != value)
            {
                _accountType = value;
                UpdatePreview();
            }
        }
    }

    private string PreviewUrl { get; set; } = "https://minotar.net/helm/MHF_Steve/100";

    protected override async Task OnInitializedAsync()
    {
        var stored = await UserService.GetUsernameAsync();
        if (!string.IsNullOrEmpty(stored))
        {
            // Storage conventions:
            // - Bedrock: prefix with '.' (e.g. ".Notch")
            // - Java: plain name (e.g. "Notch")
            ExistingUsername = stored;
            if (stored.StartsWith('.'))
            {
                AccountType = "bedrock";
                // Editable should not include the dot
                UsernameEditable = stored.Substring(1);
            }
            else
            {
                AccountType = "java";
                UsernameEditable = stored;
            }
            // Initialize preview after setting existing values
            UpdatePreview();
        }

        
    }

    

    private async Task Save()
    {
        // Only add the dot at save time for Bedrock. The input (UsernameEditable)
        // never contains the dot and the user cannot delete it.
        if (!string.IsNullOrWhiteSpace(UsernameEditable))
        {
            var toStore = UsernameEditable!;
            if (IsBedrock)
            {
                if (!toStore.StartsWith('.'))
                {
                    toStore = "." + toStore;
                }
            }
            await UserService.SetUsernameAsync(toStore);
            // Persist edition to localStorage to match the PHP flow
            await UserService.SetEditionAsync(AccountType);
        }
        Navigation.NavigateTo("/");
    }

    private void UpdatePreview()
    {
        // Determine preview based on current editable name and selected account type
        var name = UsernameEditable ?? string.Empty;
        if (string.IsNullOrWhiteSpace(name))
        {
            PreviewUrl = "https://minotar.net/helm/MHF_Steve/100";
            StateHasChanged();
            return;
        }

        if (string.Equals(AccountType, "bedrock", StringComparison.OrdinalIgnoreCase) || string.Equals(AccountType, "cracked", StringComparison.OrdinalIgnoreCase))
        {
            PreviewUrl = "https://minotar.net/helm/MHF_Steve/100";
        }
        else
        {
            PreviewUrl = $"https://minotar.net/helm/{Uri.EscapeDataString(name)}/100";
        }
        StateHasChanged();
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }
}
