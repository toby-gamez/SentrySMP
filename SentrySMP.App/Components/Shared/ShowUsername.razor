@inject SentrySMP.App.Authentication.UserService UserService

@inject NavigationManager Navigation
@inject SentrySMP.App.Services.StatusService StatusService
@implements IDisposable

@if (!string.IsNullOrEmpty(CurrentDisplay))
{
    <div class="mb-3 d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
            @if (!string.IsNullOrEmpty(SkinUrl) && string.Equals(Edition, "java", StringComparison.OrdinalIgnoreCase))
            {
                <img src="@SkinUrl" alt="skin" style="width:32px;height:32px;border-radius:4px;" />
            }
            <div>
                <small class="text-muted">Signed in as</small>
                <div><strong>@CurrentDisplay</strong></div>
            </div>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-secondary" @onclick="Logout">Log out</button>
        </div>
    </div>
}
else
{
    <div class="mb-3">
        <a class="btn btn-sm btn-primary" href="/login">Log in</a>
    </div>
}

@code {
    private string? CurrentDisplay;
    private string? SkinUrl;
    private string? Edition;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var info = await UserService.GetUserInfoAsync();
            if (info.LoggedIn)
            {
                CurrentDisplay = info.Username;
                Edition = info.Edition;
                SkinUrl = info.Skin;
                StateHasChanged();
            }
            UserService.OnChange += OnUserChanged;
        }
    }

    private async void OnUserChanged()
    {
        var info = await UserService.GetUserInfoAsync();
        if (!info.LoggedIn)
        {
            CurrentDisplay = null;
            SkinUrl = null;
            Edition = null;
        }
        else
        {
            CurrentDisplay = info.Username;
            Edition = info.Edition;
            SkinUrl = info.Skin;
        }
        StateHasChanged();
    }

    private async Task Logout()
    {
        await UserService.SetUsernameAsync(null);
        await UserService.SetEditionAsync(null);
        Navigation.NavigateTo("/");
    }

    public void Dispose()
    {
        UserService.OnChange -= OnUserChanged;
    }
}
