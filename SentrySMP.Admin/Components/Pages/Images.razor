@page "/images"
@rendermode InteractiveServer
@using SentrySMP.Shared.DTOs
@using System.Net.Http.Json
@inject ISentryApi Api
@inject HttpClient Http
@inject ILogger<Images> Logger

<PageTitle>Images - SentrySMP Admin</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Images</h3>
        <div>
            <button class="btn btn-sm btn-primary me-2" @onclick="Refresh">Refresh</button>
        </div>
    </div>

    <div class="mb-3">
        <p class="text-muted">This page lists local images and attempts to fetch the remote image list from <code>https://www.sentrysmp.eu/api/Images</code>. Thumbnails are loaded directly from <code>https://www.sentrysmp.eu/uploads/keys/...</code> when available (normal GET), otherwise the local file under <code>/uploads/keys/</code> is used.</p>
    </div>

    @if (loading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <h5>Remote vs Local images</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th style="width:80px">Preview</th>
                                <th style="width:120px">Exists Remote</th>
                                <th style="width:120px">Exists Local</th>
                                <th>File name</th>
                                <th style="width:260px">Info</th>
                                <th style="width:120px">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (allNames != null && allNames.Any())
                            {
                                @foreach (var name in allNames)
                                {
                                    var local = localDict.TryGetValue(name, out var l) ? l : null;
                                    var remote = remoteDict.TryGetValue(name, out var r) ? r : null;
                                    <tr>
                                        @* Preview: show remote GET image when available, otherwise local *@
                                        <td class="align-middle">
                                            @{
                                                string? src = null;
                                                if (remote != null && !string.IsNullOrWhiteSpace(remote.Url))
                                                {
                                                    src = remote.Url.StartsWith("http", StringComparison.OrdinalIgnoreCase) ? remote.Url : $"https://www.sentrysmp.eu{remote.Url}";
                                                }
                                                else if (local != null && !string.IsNullOrWhiteSpace(local.Url))
                                                {
                                                    src = local.Url;
                                                }
                                            }
                                            @if (!string.IsNullOrEmpty(src))
                                            {
                                                <img src="@src" style="max-width:72px;max-height:48px;object-fit:contain;border:1px solid #eee;padding:2px;background:#fff;" alt="@name" />
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                        <td class="align-middle">@((remote != null) ? (MarkupString)"<span class=\"badge bg-success\">✔</span>" : (MarkupString)"<span class=\"text-muted\">—</span>")</td>
                                        <td class="align-middle">@((local != null) ? (MarkupString)"<span class=\"badge bg-info\">✔</span>" : (MarkupString)"<span class=\"text-muted\">—</span>")</td>
                                        <td class="text-break align-middle">@name</td>
                                        <td class="align-middle small text-muted">
                                            <div>
                                                @* Compact info: Remote and Local combined into single small block *@
                                                <span class="d-block"><strong>R:</strong> @(remote != null ? (remote.Size > 0 ? FormatBytes(remote.Size) : "-") : "-") <span class="text-muted">•</span> @(remote != null ? (remote.LastModified?.UtcDateTime.ToString("yyyy-MM-dd") ?? "-") : "-")</span>
                                                <span class="d-block"><strong>L:</strong> @(local != null ? (local.Size > 0 ? FormatBytes(local.Size) : "-") : "-") <span class="text-muted">•</span> @(local != null ? (local.LastModified?.UtcDateTime.ToString("yyyy-MM-dd") ?? "-") : "-")</span>
                                            </div>
                                        </td>
                                        <td class="align-middle">
                                            @if (remote != null && local == null && !string.IsNullOrEmpty(remote.Url))
                                            {
                                                string downloadUrl = remote.Url.StartsWith("http", StringComparison.OrdinalIgnoreCase) ? remote.Url : $"https://www.sentrysmp.eu{remote.Url}";
                                                <button class="btn btn-sm btn-primary" @onclick="() => DownloadByUrl(downloadUrl)" disabled="@loading">Download</button>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No images found</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        @if (lastSyncResult != null)
        {
            <div class="mt-3">
                <h6>Last download result</h6>
                <div>
                    <strong>Downloaded:</strong>
                    @if (lastSyncResult.DownloadedWithLocalPath.Any())
                    {
                        <ul>
                            @foreach (var d in lastSyncResult.DownloadedWithLocalPath)
                            {
                                <li>@d.FileName — <span class="text-break">@d.LocalPath</span></li>
                            }
                        </ul>
                    }
                    else
                    {
                        <span>@string.Join(", ", lastSyncResult.Downloaded)</span>
                    }
                </div>

                <div>
                    <strong>Skipped (already existed):</strong>
                    @if (lastSyncResult.SkippedWithLocalPath.Any())
                    {
                        <ul>
                            @foreach (var s in lastSyncResult.SkippedWithLocalPath)
                            {
                                <li>@s.FileName — <span class="text-break">@s.LocalPath</span></li>
                            }
                        </ul>
                    }
                    else
                    {
                        <span>@string.Join(", ", lastSyncResult.Skipped)</span>
                    }
                </div>

                <div><strong>Failed:</strong>
                    @if (lastSyncResult.Failed.Any())
                    {
                        <ul>
                            @foreach (var f in lastSyncResult.Failed)
                            {
                                <li>@f.FileName (@(f.StatusCode?.ToString() ?? f.Error ?? "error"))</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </div>
            </div>
        }
}
</div>
@code {
    private IEnumerable<ImageInfoDto>? localItems;
    private IEnumerable<ImageInfoDto>? remoteItems;
    private List<string> allNames = new();
    private Dictionary<string, ImageInfoDto> localDict = new(StringComparer.OrdinalIgnoreCase);
    private Dictionary<string, ImageInfoDto> remoteDict = new(StringComparer.OrdinalIgnoreCase);
    private bool loading = false;
    private string? errorMessage;
    private bool isInitialized = false;
    private SentrySMP.Shared.DTOs.ImageSyncResultDto? lastSyncResult;

    protected override async Task OnInitializedAsync()
    {
        if (!isInitialized)
        {
            isInitialized = true;
            await Refresh();
        }
    }

    private async Task Refresh()
    {
        loading = true;
        errorMessage = null;
        try
        {
            localItems = (await Api.GetImagesAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = "Error fetching local images: " + ex.Message;
            Logger.LogError(ex, "Error fetching local images");
            localItems = Enumerable.Empty<ImageInfoDto>();
        }

        try
        {
            // fetch remote list from the external site
            remoteItems = await Http.GetFromJsonAsync<IEnumerable<ImageInfoDto>>("https://www.sentrysmp.eu/api/Images");
            remoteItems ??= Enumerable.Empty<ImageInfoDto>();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Unable to fetch remote image list from https://www.sentrysmp.eu/api/Images");
            remoteItems = Enumerable.Empty<ImageInfoDto>();
        }

        localDict = localItems.ToDictionary(i => i.FileName, StringComparer.OrdinalIgnoreCase);
        remoteDict = remoteItems.ToDictionary(i => i.FileName, StringComparer.OrdinalIgnoreCase);

        var set = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var n in localDict.Keys) set.Add(n);
        foreach (var n in remoteDict.Keys) set.Add(n);
        allNames = set.OrderBy(n => n, StringComparer.OrdinalIgnoreCase).ToList();

        loading = false;
    }

    private async Task Download(string name)
    {
        loading = true;
        errorMessage = null;
            try
            {
                // Ensure we pass a full remote base so the server downloads from the correct host.
                // The remote ImageInfo.Url from the production site is relative (e.g. "/uploads/keys/x.png"),
                // so we provide the absolute remote base here.
                var remoteBase = "https://www.sentrysmp.eu/uploads/keys/";
            var result = await Api.DownloadImageAsync(name, remoteBase);
            lastSyncResult = result;
            // Refresh lists after download
            await Refresh();
            }
        catch (Exception ex)
        {
            errorMessage = "Error downloading image: " + ex.Message;
            Logger.LogError(ex, "Error downloading image {Name}", name);
        }
        finally
        {
            loading = false;
        }
    }

        private async Task DownloadByUrl(string url)
        {
            loading = true;
            errorMessage = null;
            try
            {
                var resp = await Http.PostAsJsonAsync("/api/images/download-by-url", new { Url = url });
                if (resp.IsSuccessStatusCode)
                {
                    lastSyncResult = await resp.Content.ReadFromJsonAsync<SentrySMP.Shared.DTOs.ImageSyncResultDto>();
                    await Refresh();
                }
                else
                {
                    errorMessage = $"Download failed: {resp.StatusCode}";
                }
            }
            catch (Exception ex)
            {
                errorMessage = "Error downloading image: " + ex.Message;
                Logger.LogError(ex, "Error downloading image by url {Url}", url);
            }
            finally
            {
                loading = false;
            }
        }


    private static string FormatBytes(long bytes)
    {
        if (bytes < 1024) return bytes + " B";
        double kb = bytes / 1024d;
        if (kb < 1024) return kb.ToString("0.#") + " KB";
        double mb = kb / 1024d;
        if (mb < 1024) return mb.ToString("0.#") + " MB";
        double gb = mb / 1024d;
        return gb.ToString("0.#") + " GB";
    }
}
